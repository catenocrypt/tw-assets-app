<html>

<head>
</head>

<script type="module">
    import { request } from "https://cdn.skypack.dev/@octokit/request";
    window.request = request;
</script>

<script>
    const appName = 'tw-assets-app';
    const clientId = "b9ff96b9717574ee8189";

    var token = null;
    var loginname = null;
    var repo = null;

    const mainRepoOwner = "trustwallet";
    const mainRepoName = "assets";
    const mainRepoFullName = mainRepoOwner + "/" + mainRepoName;
    const mainRepoUrl = `https://github.com/${mainRepoFullName}.git`;
    const appScopes = "public_repo%20read:user";
    const prBodyFooter = `\n\nPR created by ${appName}`;

    function loginActionUrl() {
        return `https://github.com/login/oauth/authorize?scope=${appScopes}&client_id=${clientId}`;
    }

    function authHeaders() {
        return { authorization: `token ${token}` };
    }

    async function getUser() {
        const result = await request("GET /user", { headers: authHeaders() });
        return result.data;
    }

    function refreshUser() {
        document.getElementById("user").innerHTML = "-";
        document.getElementById("repo").innerHTML = "-";
        document.getElementById("prs").innerHTML = "-";

        if (!token) {
            document.getElementById("user").innerHTML = `Not logged in, <a href="${loginActionUrl()}">log in</a>`;
            return;
        }
        document.getElementById("user").innerHTML = `User: ${loginname} <a href="#" onclick="logout();">Logout</a>`;

        if (!repo) {
            document.getElementById("repo").innerHTML = `No fork of assets found for user ${loginname}.  Please fork the <a href="${mainRepoUrl}" target="_blank">main Assets repo</a>`;
            return;
        }

        document.getElementById("repo").innerHTML = `Repo: <a href="https://github.com/${loginname}/${repo}.git" target="_blank">${loginname}/${repo}</a>`;
    }

    async function checkUser() {
        if (!token) {
            return false;
        }
        const user = await getUser();
        if (!user || !user.login) {
            return false;
        }
        loginname = user.login;
        return true;
    }

    function clearUser() {
        token = null;
        loginname = null;
        repo = null;
    }

    async function logout() {
        clearUser();
        refreshUser();
    }

    async function getUserRepos() {
        const result = await request("GET /user/repos", { headers: authHeaders() });
        return result.data;
    }

    async function getRepo(owner, repo) {
        const result = await request("GET /repos/:owner/:repo", {
            headers: authHeaders(),
            owner: owner,
            repo: repo
        });
        return result.data;
    }

    async function checkRepo() {
        if (!token || !loginname) {
            return;
        }
        const repos = await getUserRepos();
        if (!repos || repos.length == 0) {
            return false;
        }
        // first try under 'assets' name
        for (const r of repos) {
            if (!repo && r.fork && r.name === mainRepoName) {
                const r2 = await getRepo(loginname, r.name);
                if (r2 && r2.parent && r2.parent.full_name === mainRepoFullName) {
                    repo = r.name;
                }
            }
        }
        // try again all others
        for (const r of repos) {
            if (!repo && r.fork) {
                const r2 = await getRepo(loginname, r.name);
                if (r2 && r2.parent && r2.parent.full_name === mainRepoFullName) {
                    repo = r.name;
                }
            }
        }
        return repo ? true : false;
    }

    async function getPulls(owner, repo) {
        const result = await request("GET /repos/:owner/:repo/pulls", {
            headers: authHeaders(),
            owner: owner,
            repo: repo
        });
        return result.data;
    }

    async function checkPRs() {
        document.getElementById("prs").innerHTML = "-";
        if (!loginname || !repo) {
            return;
        }
        const pulls = await getPulls(loginname, repo);
        var t = "";
        pulls.forEach(pr => t += pr.number + " ");
        document.getElementById("prs").innerHTML = "PRs: " + t;
    }

    async function getBranchRef(branch) {
        const result = await request("GET /repos/{owner}/{repo}/git/ref/{ref}", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            ref: "heads/" + branch
        });
        return result.data.object.sha;
    }

    async function createBranch(branchName) {
        const ref = await getBranchRef("master");
        const result = await request("POST /repos/:owner/:repo/git/refs", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            ref: `refs/heads/${branchName}`,
            sha: ref
        });
        return result.data.ref;
    }

    async function createPull(branchName, debugLocalRepoOnly) {
        const title = "Test PR cc";
        var owner1 = mainRepoOwner;
        var repo1 = mainRepoName;
        if (debugLocalRepoOnly) {
            owner1 = loginname;
            repo1 = repo;
        }
        const result = await request("POST /repos/:owner/:repo/pulls", {
            headers: authHeaders(),
            owner: owner1,
            repo: repo1,
            title: title,
            head: loginname + ":" + branchName,
            base: "master",
            body: "This is a test" + prBodyFooter,
            maintainer_can_modify: true,
            draft: true
        });
        return result.data.number;
    }

    function newBranchName() {
        const today = new Date();
        const date = (today.getMonth() + 1).toString().padStart(2, '0') + today.getDate().toString().padStart(2, '0') +
            '-' + today.getHours().toString().padStart(2, '0') + today.getMinutes().toString().padStart(2, '0') + today.getSeconds().toString().padStart(2, '0');
        return "br" + date;
    }

    async function createBlob(content) {
        const result = await request("POST /repos/:owner/:repo/git/blobs", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            content: content,
            encoding: "utf-8"
        });
        return result.data.sha;
    }

    async function createFiles(basePath, subFolder) {
        var fileInfos = [];

        const folder = basePath + "/" + subFolder;
        //fileInfos.push({ path: folder, mode: "040000", type: "blob" });

        const content1 = "[PNG]";
        const sha1 = await createBlob(content1);
        if (!sha1) {
            return null;
        }
        fileInfos.push({ path: folder + "/logo.png", sha: sha1, mode: "100644", type: "blob" });

        const content2 = JSON.stringify({name: "TEST", short_description: "short test desc"});
        fileInfos.push({ path: folder + "/info.json", content: content2, mode: "100644", type: "blob" });

        return fileInfos;
    }

    async function createTree(baseSha, fileInfos) {
        const result = await request("POST /repos/:owner/:repo/git/trees", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            tree: fileInfos,
            base_tree: baseSha
        });
        return result.data.sha;
    }

    async function createCommit(baseSha, tree) {
        const result = await request("POST /repos/:owner/:repo/git/commits", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            message: "Adding new asset",
            tree: tree,
            parents: [baseSha]
        });
        return result.data.sha;
    }

    async function updateReference(ref, sha) {
        const result = await request("POST /repos/:owner/:repo/git/refs/:ref", {
            headers: authHeaders(),
            owner: loginname,
            repo: repo,
            ref: ref,
            sha: sha
        });
        return result.data.object.sha;
    }

    async function createBranchAndPull() {
        const branchName = newBranchName();
        const branchRef = await createBranch(branchName);
        if (!branchRef) {
            console.log(`Could not create branch ${branchName}`);
            return;
        }

        const fileInfos = await createFiles("blockchains/ethereum/assets", "0x63A6da104C6a08dfeB50D13a7488F67bC98Cc41f");
        if (!fileInfos || fileInfos.length == 0) {
            console.log(`Could not create files`);
            return;
        }

        const branchSha = await getBranchRef(branchName);
        if (!branchSha) {
            console.log(`Could not get ref for branch ${branchName}`);
            return;
        }

        const tree = await createTree(branchSha, fileInfos);
        if (!tree) {
            console.log(`Could not create tree with files`);
            return;
        }

        const commit = await createCommit(branchSha, tree);
        if (!commit) {
            console.log(`Could not create commit`);
            return;
        }

        const newBranchSha = await updateReference("heads/" + branchName, commit);
        if (!newBranchSha) {
            console.log(`Could not update branch ${branchName} to commit ${commit}`);
            return;
        }

        const pullNumber = await createPull(branchName, false);
    }

    function getTokenQP() {
        var urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("token");
    }

    async function start() {
        clearUser();
        refreshUser();
        token = getTokenQP();
        if (!await checkUser()) {
            refreshUser();
            return;
        }
        if (!await checkRepo()) {
            refreshUser();
            return;
        }
        refreshUser();
        await checkPRs();
    }
</script>

<body onload="start()">
    <div>
        <a href="/">TW Assets App</a>
    </div>
    <div id="user">-</div>
    <div id="repo">-</div>
    <div id="prs">-</div>
    <a href="#" onclick="createBranchAndPull()">Create PR</a>
</body>

</html>