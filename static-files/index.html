<html>

<head>
    <link rel="stylesheet" href="style.css">

    <!-- Vue.js  -->
    <!-- Development version, includes helpful console warnings -->
    <!-- script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script -->
    <!-- Production version, optimized for size and speed -->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
</head>

<!-- Own library -->
<script type="module" src="bundle.js"></script>

<script>
    const appName = "tw-assets-management";
    const clientId = "b9ff96b9717574ee8189";

    const sampleEthContract = "0x6d84682C82526E245f50975190EF0Fff4E4fc077";
    const testLogoUrls = [
        "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x47F32f9eBFc49a1434eB6190d5D8a80A2Dc36af5/logo.png",
        "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x9B9087756eCa997C5D595C840263001c9a26646D/logo.png",
        "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xd4c435F5B09F855C3317c8524Cb1F586E42795fa/logo.png",
        "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0x86876a5fCAcb52a197f194A2c8b2166Af327a6da/logo.png",
        "https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xD5525D397898e5502075Ea5E830d8914f6F0affe/logo.png"
    ];

    function addLog(message) {
        console.log(message);
        //const newvalue = document.getElementById("log").value + message + "\n"
        //document.getElementById("log").value = newvalue;
    }

    async function myAlert(message) {
        addLog(message);
        alert(message);
    }

    // Retrieve the size of an image (url or stream) but placing in a hidden img and retrieving size
    async function getImageDimension(url, stream = null) {
        try {
            const img = document.getElementById("image-placeholder-for-size-computation");
            //img.src = "";
            if (stream) {
                img.src = "data:image/gif;base64," + stream;
            } else {
                img.src = url;
            }
            return { x: img.naturalWidth, y: img.naturalHeight };
        } catch (error) {
            console.log("getImageDimension exception", error);
            return { x: 0, y: 0 }
        }
    }

    // return [ArrayBuffer, content-type]
    async function logoStreamFromUrl(testLogoUrl) {
        if (!testLogoUrl) {
            return [null, null];
        }
        const response = await fetch(testLogoUrl);
        if (!response || !response.status == 200) {
            addLog(`Logo stream error ${url}`);
            return [null, null];
        }
        return [await response.arrayBuffer(), response.headers.get('Content-Type')];
    }

    function arrayBufferToBase64(buffer) {
        var binary = '';
        var bytes = new Uint8Array(buffer);
        var len = bytes.byteLength;
        for (var i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    function createBranchAndPull() {
        // TODO
        console.log('createBranchAndPull', JSON.stringify(tokenInput));
    }

    function start() {
        var app = new Vue({
            el: '#app',
            data: {
                activeTab: 'tab-add',
                tokenInput: tokenInput = new script.assets.TokenInput(),
                tokenInputCheckResult: '',
                inputLogoText: '',
                debugMode: false,
                testLogoIndex: 0
            },
            methods: {
                selectTab: async function (tab) {
                    this.activeTab = tab;
                    if (this.activeTab == 'tab-prs') {
                        loadOpenPrs();
                    }
                },
                checkInput: async function () {
                    // don't display check result if all inputs are emopty
                    if (!tokenInput.name && !tokenInput.contract && !tokenInput.logoStream) {
                        this.tokenInputCheckResult = "";
                        //document.getElementById("input.check-result").style["color"] = "";
                        return "";
                    }

                    // auto-fill explorer
                    if (tokenInput.contract && !tokenInput.explorerUrl) {
                        const explorer = script.assets.explorerUrl(tokenInput.type, tokenInput.contract);
                        tokenInput.explorerUrl = explorer;
                    }

                    const [resnum, resmsg, fixed] = await script.assets.checkTokenInput(tokenInput, { get: getImageDimension });
                    if (resnum >= 2) {
                        this.tokenInputCheckResult = "ERROR:\n" + resmsg;
                        //document.getElementById("input.check-result").style["color"] = "red";
                    } else if (resnum >= 1) {
                        this.tokenInputCheckResult = "Warning:\n" + resmsg;
                        //document.getElementById("input.check-result").style["color"] = "orange";
                    } else {
                        this.tokenInputCheckResult = "OK\n" + resmsg;
                        //document.getElementById("input.check-result").style["color"] = "";
                    }
                },
                checkInputButton: async function () {
                    await this.checkInput();
                    addLog("starting TokenInput check...");
                    const [resnum, resmsg, fixed] = await script.assets.checkTokenInput(tokenInput, { get: getImageDimension });
                    if (resnum == 0) {
                        myAlert("Check result: OK\n" + resmsg);
                        return;
                    }
                    if (!fixed) {
                        // cannot be fixed
                        if (resnum >= 2) {
                            myAlert("Check result: ERROR\n" + resmsg);
                            return;
                        }
                        myAlert("Check result: Warning\n" + resmsg);
                        return;
                    }
                    // can be fixed
                    tokenInput = fixed;
                    myAlert("Check result: Fixed! \n " + resmsg);
                },
                clearInput: function () {
                    this.tokenInput = new script.assets.TokenInput();
                    this.inputLogoSetStream(null, null, 0, null);
                },
                inputLogoSetStream: function (stream, hintName, hintSize, hintMime) {
                    if (!stream) {
                        this.tokenInput.logoStream = null;
                        this.tokenInput.logoStreamSize = 0;
                        this.tokenInput.logoStreamType = null;
                        this.inputLogoText = "(no image)";
                        return;
                    }
                    this.tokenInput.logoStream = stream;
                    let text = "(";

                    this.tokenInput.logoStreamSize = 0;
                    if (hintSize && hintSize > 0) {
                        this.tokenInput.logoStreamSize = hintSize;
                        text += `${hintSize} bytes`;
                    } else {
                        text += `${tokenInput.logoStream.length} base64 bytes`;
                    }
                    if (hintName) {
                        text += `, ${hintName}`;
                    }
                    this.tokenInput.logoStreamType = "";
                    if (hintMime) {
                        this.tokenInput.logoStreamType = hintMime;
                        text += `, ${hintMime}`;
                    }

                    text += ")";
                    this.inputLogoText = text;
                },
                logoFileSelected: async function () {
                    const file = document.getElementById("input.file-selector").files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.readAsArrayBuffer(file);
                        app = this;
                        reader.onload = async function (evt) {
                            var contents = evt.target.result;
                            var base64 = arrayBufferToBase64(contents);
                            app.inputLogoSetStream(base64, file.name, file.size, file.type);
                            //await checkAndRefreshTokenInfo();
                        }
                        reader.onerror = function (evt) {
                            myAlert(`Error reading file ${file.name}`);
                        }
                    }
                },
                debugTestLogoGetNext: async function() {
                    this.testLogoIndex = (this.testLogoIndex + 1) % testLogoUrls.length;
                    const [streamArray, mime] = await logoStreamFromUrl(testLogoUrls[this.testLogoIndex]);
                    const stream = arrayBufferToBase64(streamArray);
                    this.inputLogoSetStream(stream, "test" + this.testLogoIndex, streamArray.byteLength, mime);
                },
                debugFillWithDummyData: async function() {
                    this.tokenInput.name = "LegumeToken";
                    this.tokenInput.type = "erc20";
                    this.tokenInput.contract = sampleEthContract;
                    this.tokenInput.website = "https://en.wikipedia.org/wiki/Legume";
                    this.tokenInput.description = "This is the best-tasting DeFi finance project.";
                    this.tokenInput.explorerUrl = `https://etherscan.io/token/${sampleEthContract}`;
                    await this.debugTestLogoGetNext();
                }
            }
        });
    }
</script>

<body onload="start()">
    <span id="app">
        <div id="header">
            <span id="menu-left">
                <a v-on:click="selectTab('tab-add')">Add New Token</a>
                <a v-on:click="selectTab('tab-prs')">Pull Requests</a>
                <a v-on:click="selectTab('tab-search')">Token Search</a>
            </span>
        </div>
        <div id="main">
            <div class="tab-pane" v-show="activeTab == 'tab-add'">
                <div>
                    <h3>Add Token</h3>
                    Please fill in the token/project details
                </div>
                <div>
                    <table>
                        <tr>
                            <td>Name:</td>
                            <td>
                                <input v-model="tokenInput.name" class="input" placeholder="Token Name" size="20" />
                            </td>
                        </tr>
                        <tr>
                            <td>Type:</td>
                            <td>
                                <select v-model="tokenInput.type" class="input">
                                    <option value="erc20">ERC20 (Ethereum)</option>
                                    <option value="bep2">BEP2 (Binance)</option>
                                    <option value="bep20">BEP20 (Binance Smart Chain)</option>
                                    <option value="trc10">TRC10 (Tron)</option>
                                    <option value="trc20">TRC20 (Tron)</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Contract/ID:</td>
                            <td>
                                <input v-model="tokenInput.contract" class="input"
                                    placeholder="0xF784682C82526e245F50975190EF0fff4E4fC077" size="40" />
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div>Logo:</div>
                            </td>
                            <td>
                                <div>
                                    <button class="button"
                                        onclick="document.getElementById('input.file-selector').click();">Upload</button>
                                    <input id="input.file-selector" type="file" style="display: none;"
                                        v-on:change="logoFileSelected();" />
                                    <span v-html="inputLogoText" id="input.logo-input"></span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Website:</td>
                            <td>
                                <input v-model="tokenInput.website" class="input" placeholder="https://tokenproject.fi"
                                    size="40" />
                            </td>
                        </tr>
                        <tr>
                            <td>Explorer:</td>
                            <td>
                                <input v-model="tokenInput.explorerUrl" class="input"
                                    placeholder="https://etherscan.io/token/0xF784682C82526e245F50975190EF0fff4E4fC077"
                                    size="40" />
                            </td>
                        </tr>
                        <tr>
                            <td>Short description:</td>
                            <td><textarea v-model="tokenInput.description" class="input"
                                    placeholder="Short description of the project" style="width: 100%;"
                                    rows="2"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>Check result:</td>
                            <td><textarea v-model="tokenInputCheckResult" class="input" style="width: 100%;"
                                    rows="3"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>
                                <button class="button" type="button" onclick="createBranchAndPull()">Create PR</button>
                                <button class="button" type="button" v-on:click="checkInputButton()">Check/Fix</button>
                                <button class="button" type="button" v-on:click="clearInput()">Clear</button>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div>
                <table>
                    <tr>
                        <td>

                            <div class="tab-pane" v-show="activeTab == 'tab-prs'">
                                <div>
                                    <h3>Pull Requests</h3>
                                </div>
                            </div>
                            <div class="tab-pane" v-show="activeTab == 'tab-search'">
                                <div>
                                    <h3>Token Search</h3>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div v-show="activeTab != 'tab-add'">
                                <div>
                                    <h3>Token View</h3>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div hidden="true">
                <img id="image-placeholder-for-size-computation" src="favicon.ico" />
            </div>
            <div v-show="debugMode">
                <div>Debug Mode</div>
                <div>
                    <button class="button" type="button" v-on:click="debugFillWithDummyData();">Fill test data</button>
                </div>
            </div>
        </div>
        <div id="footer">
            <span id="footer-left">
                <input type="checkbox" id="cb_debug_mode" v-model="debugMode" /><label for="cb_debug_mode">Debug Mode</label>
            </span>
            <span id="footer-right">
                <a>Trust Wallet Assets App</a>
                <img src="favicon.ico" height="20" />
            </span>
        </div>
    </span>
</body>

</html>